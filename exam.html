<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Olimpiada Tecnolog√≠a Las Nieves</title>
  <link rel="icon" type="image/png" href="img/descarga (11).png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Cron√≥metro futurista tipo bomba */
    .timer-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, hsl(170, 97%, 36%) 0%, hsl(199, 100%, 67%) 100%);
      border-radius: 50%;
      width: 120px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(92, 193, 255, 0.5),
                  0 0 60px rgba(3, 188, 132, 0.3),
                  inset 0 0 20px rgba(0, 0, 0, 0.2);
      border: 3px solid hsl(199, 100%, 67%);
      animation: pulse 2s infinite;
      transition: all 0.3s ease;
    }
    
    .timer-container.warning {
      animation: pulse 1s infinite, shake 0.5s infinite;
      box-shadow: 0 0 40px rgba(255, 193, 7, 0.8),
                  0 0 80px rgba(255, 193, 7, 0.5),
                  inset 0 0 30px rgba(255, 193, 7, 0.3);
      border-color: #ffc107;
    }
    
    .timer-container.critical {
      animation: pulse 0.5s infinite, shake 0.3s infinite;
      box-shadow: 0 0 50px rgba(255, 152, 0, 1),
                  0 0 100px rgba(255, 152, 0, 0.7),
                  inset 0 0 40px rgba(255, 152, 0, 0.5);
      border-color: #ff9800;
      transform: scale(1.1);
    }
    
    .timer-label {
      color: #ffffff;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    
    .timer {
      font-size: 2rem;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                   0 0 20px rgba(255, 255, 255, 0.5);
      font-family: 'Courier New', monospace;
      min-width: 80px;
      text-align: center;
    }
    
    .timer.warning {
      color: #ffc107;
      text-shadow: 0 0 10px rgba(255, 193, 7, 0.8),
                   0 0 20px rgba(255, 193, 7, 0.5);
    }
    
    .timer.critical {
      color: #ff9800;
      text-shadow: 0 0 10px rgba(255, 152, 0, 0.8),
                   0 0 20px rgba(255, 152, 0, 0.5);
      animation: blink 0.5s infinite;
    }
    
    /* Barra de progreso circular */
    .timer-progress {
      position: absolute;
      top: -3px;
      left: -3px;
      width: 126px;
      height: 126px;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #ffffff 0deg,
        #ffffff var(--progress),
        transparent var(--progress)
      );
      mask: radial-gradient(farthest-side, transparent calc(100% - 6px), #000 calc(100% - 5px));
      -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 6px), #000 calc(100% - 5px));
    }
    
    .timer-progress.warning {
      background: conic-gradient(
        from 0deg,
        #ffc107 0deg,
        #ffc107 var(--progress),
        transparent var(--progress)
      );
    }
    
    .timer-progress.critical {
      background: conic-gradient(
        from 0deg,
        #ff9800 0deg,
        #ff9800 var(--progress),
        transparent var(--progress)
      );
    }
    
    /* Animaciones */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 30px rgba(92, 193, 255, 0.5),
                    0 0 60px rgba(3, 188, 132, 0.3),
                    inset 0 0 20px rgba(0, 0, 0, 0.2);
      }
      50% {
        box-shadow: 0 0 40px rgba(92, 193, 255, 0.7),
                    0 0 80px rgba(3, 188, 132, 0.5),
                    inset 0 0 30px rgba(0, 0, 0, 0.3);
      }
      100% {
        box-shadow: 0 0 30px rgba(92, 193, 255, 0.5),
                    0 0 60px rgba(3, 188, 132, 0.3),
                    inset 0 0 20px rgba(0, 0, 0, 0.2);
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    

    .question {
      margin-bottom: 2rem;
    }
    
    /* Ajuste para que el contenido no quede detr√°s del timer */
    .wide-container {
      padding-top: 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .timer-container {
        width: 100px;
        height: 100px;
        top: 10px;
        right: 10px;
      }
      
      .timer {
        font-size: 1.5rem;
      }
      
      .timer-progress {
        width: 106px;
        height: 106px;
      }
    }
  </style>
</head>

<body>
  <div class="wide-container">
    <h2 class="mb-4">Examen</h2>
    
    <!-- Cron√≥metro Futurista Flotante -->
    <div class="timer-container" id="timerContainer">
      <div class="timer-progress" id="timerProgress"></div>
      <div class="timer-label">TIEMPO</div>
      <div id="timer" class="timer">03:00</div>
    </div>

    <form id="examForm">
      <div id="questions-container"></div>
      <button type="submit" class="btn btn-primary">Enviar respuestas</button>
    </form>
  </div>

  <div class="character-container">
    <img src="img/Personaje.png" alt="Personaje" class="character-img">
    <div class="dialog-bubble">
      ¬°Record√°! Mientras m√°s r√°pido termines,<br>
      m√°s puntos obtendr√°s por el multiplicador de tiempo.
    </div>
  </div>

  <script>
    // Verificar autenticaci√≥n al cargar
    document.addEventListener('DOMContentLoaded', function() {
      const dni = localStorage.getItem('dni');
      
      if (!dni) {
        alert('Debes iniciar sesi√≥n para acceder al examen');
        window.location.href = 'login.html';
        return;
      }
    });

    // üëá Simulamos preguntas
    const fakeResponse = {
      "questions": [
        {
          "id": 3,
          "enunciado": "que es nvidia",
          "answers": [
            { "id": 9, "contenido": "Una empresa" },
            { "id": 10, "contenido": "Una parte de la pc" },
            { "id": 11, "contenido": "Un sentimiento" },
            { "id": 12, "contenido": "Ni idea" }
          ]
        },
        {
          "id": 1,
          "enunciado": "que es la ram?",
          "answers": [
            { "id": 1, "contenido": "Una placa de video" },
            { "id": 2, "contenido": "Una memoria" },
            { "id": 3, "contenido": "Para el cd" },
            { "id": 4, "contenido": "Una camioneta" }
          ]
        },
        {
          "id": 2,
          "enunciado": "para que sirve el motherboard",
          "answers": [
            { "id": 5, "contenido": "Para lo jueguitos" },
            { "id": 6, "contenido": "Para pensar" },
            { "id": 7, "contenido": "Es la computadora madre" },
            { "id": 8, "contenido": "Conectar componentes" }
          ]
        }
      ]
    };

    // üìù Render de preguntas (primera opci√≥n preseleccionada)
    function loadQuestions(data) {
      const container = document.getElementById("questions-container");

      data.questions.forEach((q, index) => {
        const div = document.createElement("div");
        div.classList.add("question");

        let html = `<p><strong>${index + 1}. ${q.enunciado}</strong></p>`;
        q.answers.forEach((ans, i) => {
          html += `
            <div class="form-check">
              <input class="form-check-input" type="radio" 
                     name="q_${q.id}" 
                     value="${ans.id}" 
                     id="ans_${ans.id}" 
                     ${i === 0 ? "checked" : ""}>
              <label class="form-check-label" for="ans_${ans.id}">${ans.contenido}</label>
            </div>
          `;
        });

        div.innerHTML = html;
        container.appendChild(div);
      });
    }

    // ‚è± Temporizador Futurista
    const totalTime = 180; // 3 minutos en segundos
    let timeLeft = totalTime;
    let isTimeUp = false;
    const timerEl = document.getElementById("timer");
    const timerContainer = document.getElementById("timerContainer");
    const timerProgress = document.getElementById("timerProgress");
    
    const countdown = setInterval(() => {
      timeLeft--;
      const min = String(Math.floor(timeLeft / 60)).padStart(2, "0");
      const sec = String(timeLeft % 60).padStart(2, "0");
      timerEl.textContent = `${min}:${sec}`;
      
      // Actualizar barra de progreso circular
      const progress = (timeLeft / totalTime) * 360;
      timerProgress.style.setProperty('--progress', `${progress}deg`);
      
      // Cambiar colores seg√∫n el tiempo restante
      if (timeLeft <= 30) {
        // √öltimos 30 segundos - CR√çTICO
        timerEl.classList.remove('warning');
        timerEl.classList.add('critical');
        timerContainer.classList.remove('warning');
        timerContainer.classList.add('critical');
        timerProgress.classList.remove('warning');
        timerProgress.classList.add('critical');
      } else if (timeLeft <= 60) {
        // √öltimo minuto - ADVERTENCIA
        timerEl.classList.add('warning');
        timerContainer.classList.add('warning');
        timerProgress.classList.add('warning');
      }

      if (timeLeft <= 0) {
        clearInterval(countdown);
        isTimeUp = true;
        timerEl.textContent = "00:00";
        submitAnswers(); // üî• env√≠o autom√°tico sin alerta
      }
    }, 1000);

    // üöÄ Submit manual
    document.getElementById("examForm").addEventListener("submit", function (e) {
      e.preventDefault();
      submitAnswers();
    });

    // üì§ Armado y env√≠o
    async function submitAnswers() {
      // Detener el cronometro inmediatamente
      clearInterval(countdown);
      
      const form = document.getElementById("examForm");
      const formData = new FormData(form);
      const answers = {};

      for (let [key, value] of formData.entries()) {
        const questionId = key.split("_")[1];
        answers[questionId] = parseInt(value);
      }
      
      // Calcular tiempo restante en segundos
      const timeRemaining = Math.max(0, timeLeft);

      console.log("Respuestas a enviar:", { answers, time_remaining: timeRemaining });

      try {
        const dni = localStorage.getItem("dni");
        const examId = localStorage.getItem("currentExamId") || "1";
        const response = await fetch(`https://tpfinal.store/api/exams/${examId}/submit`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "dni": dni
          },
          body: JSON.stringify({ 
            answers: answers,
            time_remaining: timeRemaining 
          })
        });

        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const result = await response.json();
        console.log("Respuesta del servidor:", result);
        
        // Guardar resultado para mostrar en result.html
        localStorage.setItem("examResult", JSON.stringify(result));
        window.location.href = "result.html";
      } catch (err) {
        console.error("Error al enviar examen:", err);
        // Si se acab√≥ el tiempo, redirigir sin mostrar alerta
        if (isTimeUp) {
          window.location.href = "result.html";
        } else {
          alert("Error al enviar examen ‚ùå");
        }
      }
    }

    // üöÄ Inicializamos - Cargamos preguntas del servidor
    async function loadExamQuestions() {
      try {
        const examId = localStorage.getItem("currentExamId") || "1";
        console.log("Cargando preguntas desde:", `https://tpfinal.store/api/exams/${examId}/questions`);
        console.log("DNI:", localStorage.getItem("dni"));
        
        const dni = localStorage.getItem("dni");
        const response = await fetch(`https://tpfinal.store/api/exams/${examId}/questions`, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "dni": dni
          }
        });

        console.log("Response status:", response.status);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log("Preguntas recibidas:", data);
        loadQuestions(data);
      } catch (err) {
        console.error("Error al cargar preguntas:", err);
        console.log("Usando preguntas de prueba...");
        loadQuestions(fakeResponse);
      }
    }

    loadExamQuestions();
  </script>
</body>

</html>
